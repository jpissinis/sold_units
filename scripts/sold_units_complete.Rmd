---
title: "sold_units_complete"
author: "Francisco Finochietto and Jer√≥nimo Pissinis"
date: "2/27/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analysis of the factors related with the number of units sold per year

```{r , echo=TRUE}
#Importing the packages
library(readr)
library(car)
library(glmnet)
library(leaps)
```


Importing the data
```{r , echo=TRUE}
file_path<-"../raw/sold_units_complete.csv"
sold_units<-read_csv(file_path)

#Dropping the year column.
sold_units<-sold_units[,-1]

#Centering the variables to reduce structural multicolinearity
sold_units[,8]<-scale(sold_units[,8],scale=FALSE)
sold_units[,9]<-scale(sold_units[,9],scale=FALSE)
sold_units[,10]<-scale(sold_units[,10],scale=FALSE)

#Renaming the columns
my_names<-c("num_units", "itcrb", "imported_cars", "semiconductor_crisis",
            "devaluacion_interanual", "inflation", "import_restriction",
            "PIB", "reserves", "PIB_over_reserves", "exchange_difference",
            "industry_trade_balance_diference")
names(sold_units)<-my_names
```


Building the model
```{r , echo=TRUE}
sold_units_selected<-lm(sold_units)
summary(sold_units_selected)
```


Pairwise plots of the features
```{r , echo=TRUE}
pairs(sold_units)
```

Analyzing the residuals
```{r , echo=TRUE}
plot(fitted(sold_units_selected),residuals(sold_units_selected))
qqnorm(residuals(sold_units_selected))
```


Looking for outliers and high leverage points
```{r , echo=TRUE}
plot(fitted(sold_units_selected),rstandard(sold_units_selected))
plot(hatvalues(sold_units_selected))
abline(h=length(coef(sold_units_selected))/nrow(sold_units)*2, 
       col = "red",lty = 2)
plot(rstandard((sold_units_selected)))
```


Looking for colinearity
Correlation matrix
```{r , echo=TRUE}
cor(sold_units[,-1])
```

Variance inflation factors
```{r , echo=TRUE}
vif(sold_units_selected)
```

Eigenvalues of the correlation matrix
```{r , echo=TRUE}
eigen(cor(sold_units[,-1]))
```

# Feature selection
Applying best subset selection
```{r , echo=TRUE}
sold_units_subsets<-regsubsets(sold_units$num_units~.,sold_units,nvmax = 12)
summary(sold_units_subsets)
plot(summary(sold_units_subsets)$adjr2)
plot (sold_units_subsets, scale = "adjr2")
best_adjr2<-which.max(summary(sold_units_subsets)$adjr2)
selected_coef<-names(coef(sold_units_subsets, best_adjr2))
```

Building the selected model
```{r , echo=TRUE}
sold_units_selected<-
  lm(sold_units[,names(sold_units)%in%
    c("num_units",selected_coef)])
summary(sold_units_selected)
```


Analyzing the residuals
```{r , echo=TRUE}
plot(fitted(sold_units_selected),residuals(sold_units_selected))
qqnorm(residuals(sold_units_selected))
```

Looking for outliers and high leverage points
```{r , echo=TRUE}
plot(fitted(sold_units_selected),rstandard(sold_units_selected))
plot(hatvalues(sold_units_selected))
abline(h=length(coef(sold_units_selected))/nrow(sold_units)*2, 
       col = "red",lty = 2)
high_leverage_points<-hatvalues(sold_units_selected)>
  (length(coef(sold_units_selected))/nrow(sold_units)*2)
plot(rstandard(sold_units_selected), 
     col = factor(standard_res_high_lev$high_leverage_points))
```

Looking for colinearity
Correlation matrix and its eigen values
```{r , echo=TRUE}
selected_coef_cor<-cor(sold_units[,names(sold_units)%in%selected_coef])
selected_coef_cor
eigen(selected_coef_cor)$values
```

Variance inflation factors
```{r , echo=TRUE}
vif(sold_units_selected)
```

Removing the high leverage outlier
```{r , echo=TRUE}
sold_units_selected_rm<-
  lm(sold_units[!(high_leverage_points &
                    (rstandard(sold_units_selected)>2)),
                  names(sold_units)%in% c("num_units",selected_coef)])
summary(sold_units_selected_rm)
summary(sold_units_selected)
vif(sold_units_selected_rm)
```
